#!/usr/bin/env ruby

lib_path = File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))
$LOAD_PATH.unshift lib_path unless $LOAD_PATH.include?(lib_path)

require 'starling/timeline/mine'
require 'starling/access/get_access_token'
require 'starling/output/cli'
require 'oauth'
require 'tweetstream'


consumer = OAuth::Consumer.new(
  'OqWJ77FNMTNOTjojT9gHMA',
  'vd7OcWDBUeDvXCEpL3O6zkGkyZV8x4E9e0mXIufDwk',
  :site => 'https://api.twitter.com',
  :scheme => :header
)
token_grabber = Starling::Access::GetAccessToken.new(consumer, Starling::Access::Token.new(File.open('.access_token', 'r+')))

token = token_grabber.get_token
if token.nil?
  token_url = token_grabber.get_access_token_url
  puts "Please visit #{token_url} to obtain a PIN"
  puts "Please enter the PIN:"
  pin = gets.chomp
  token = token_grabber.store_oauth_token(pin).get_token
end

TweetStream.configure do |config|
  config.consumer_key = 'OqWJ77FNMTNOTjojT9gHMA'
  config.consumer_secret = 'vd7OcWDBUeDvXCEpL3O6zkGkyZV8x4E9e0mXIufDwk'
  config.oauth_token = token[:token]
  config.oauth_token_secret = token[:secret]
  config.auth_method = :oauth
end

EM.run do
  timeline = Starling::Timeline::Mine.new(TweetStream::Client.new, [])
  require "readline"
  Thread.start do
    while buf = Readline.readline("> ", true)
      if buf == 'stop'
        timeline.stop
      else
        p buf
      end
    end
  end

  EM.add_periodic_timer(1) do
    Starling::Output::CLI.new(timeline.output).output

    timeline.output.clear
    Readline.refresh_line
  end

  timeline.latest
end

# vim:filetype=ruby
